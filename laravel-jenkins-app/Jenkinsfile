pipeline {
    agent any
    
    environment {
        APP_DIR = 'laravel-jenkins-app/src'
        COMPOSE_FILE = 'laravel-jenkins-app/docker-compose.yml'
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout code from GitHub repository
                    git branch: 'main', 
                        credentialsId: 'github-credentials', 
                        url: 'https://github.com/Rofiq02bae/nangkring.git'
                    
                    // Alternative: menggunakan checkout scm untuk automatic SCM detection
                    // checkout scm
                }
            }
        }
        
        stage('Dependencies') {
            parallel {
                stage('Composer Install') {
                    steps {
                        dir("${APP_DIR}") {
                            sh 'composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev'
                        }
                    }
                }
                stage('NPM Install') {
                    steps {
                        dir("${APP_DIR}") {
                            sh 'npm ci --only=production'
                        }
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                dir("${APP_DIR}") {
                    sh 'npm run build'
                }
            }
        }
        
        stage('Migrate') {
            steps {
                script {
                    // Pastikan database service running
                    sh "docker-compose -f ${COMPOSE_FILE} up -d db"
                    // Wait for database to be ready
                    sh 'sleep 10'
                    // Run migrations
                    sh "docker-compose -f ${COMPOSE_FILE} exec -T app php artisan migrate --force"
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    // Restart Laravel container untuk deploy perubahan
                    sh "docker-compose -f ${COMPOSE_FILE} down app"
                    sh "docker-compose -f ${COMPOSE_FILE} up -d --build app"
                    
                    // Health check
                    sh 'sleep 5'
                    sh 'curl -f http://localhost:8000 || exit 1'
                }
            }
        }
    }
    
    post {
        success {
            echo '✅ Pipeline completed successfully! Laravel app deployed.'
        }
        failure {
            echo '❌ Pipeline failed. Check logs for details.'
            // Rollback jika diperlukan
            sh "docker-compose -f ${COMPOSE_FILE} down || true"
        }
        always {
            // Cleanup workspace
            cleanWs()
        }
    }
}