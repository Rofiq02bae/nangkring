name: Debug Laravel CI

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_mysql, mbstring, bcmath, gd, intl, curl, zip

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
        working-directory: ./laravel-jenkins-app/src
        continue-on-error: true

      - name: Install NPM dependencies
        run: npm install
        working-directory: ./laravel-jenkins-app/src
        continue-on-error: true

      - name: Build assets
        run: npm run build
        working-directory: ./laravel-jenkins-app/src
        continue-on-error: true

      - name: Check if composer.json exists
        run: |
          if [ -f "./laravel-jenkins-app/src/composer.json" ]; then
            echo "✅ composer.json found"
            cat ./laravel-jenkins-app/src/composer.json | head -10
          else
            echo "❌ composer.json not found"
            echo "📂 Directory contents:"
            ls -la ./laravel-jenkins-app/src/
          fi

      - name: Check if package.json exists
        run: |
          if [ -f "./laravel-jenkins-app/src/package.json" ]; then
            echo "✅ package.json found"
            cat ./laravel-jenkins-app/src/package.json | head -10
          else
            echo "❌ package.json not found"
            echo "📂 Creating basic package.json"
            mkdir -p ./laravel-jenkins-app/src
            cat > ./laravel-jenkins-app/src/package.json << 'EOF'
          {
            "name": "laravel-vite-app",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "dev": "vite",
              "build": "vite build"
            },
            "devDependencies": {
              "vite": "^4.0.0",
              "laravel-vite-plugin": "^0.7.0"
            }
          }
          EOF
          fi

      - name: Print environment variables
        run: env

      - name: PHP version
        run: php -v

      - name: Node version
        run: node -v

      - name: Composer version
        run: composer --version

      - name: NPM version
        run: npm -v

      - name: Debug and handle errors gracefully
        run: |
          echo "🔍 Debugging workflow environment..."
          echo "Working directory: $(pwd)"
          echo "GitHub workspace: $GITHUB_WORKSPACE"
          echo "Available files:"
          find . -name "*.json" -o -name "*.php" -o -name "artisan" | head -20
          
          echo "📊 System information:"
          echo "PHP version: $(php -v | head -1)"
          echo "Composer version: $(composer --version)"
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
          
          # Check Laravel installation
          if [ -f "./laravel-jenkins-app/src/artisan" ]; then
            echo "✅ Laravel installation found"
            cd ./laravel-jenkins-app/src && php artisan --version
          else
            echo "❌ Laravel not found, but that's expected for debugging"
          fi
        continue-on-error: true
